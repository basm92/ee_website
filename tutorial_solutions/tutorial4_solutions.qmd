---
title: "Solutions Tutorial 4"
format: html
---

```{r setup}
#| warning: false
#| message: false
#| echo: false

library(ggplot2)
library(gridExtra)
library(reticulate)
use_python("/home/bas/anaconda3/bin/python")
```


## Estimating a FE Model



## Estimating a FD Model


## Visualizing Unobserved Heterogeneity

The "fixed effects" ($\alpha_i$) estimated in an FE model represent the time-invariant, unobserved characteristics of each individual (e.g., innate ability, motivation, family background) that affect their wage. Visualizing the distribution of these effects can reveal the extent of this heterogeneity.

1.  Estimate a Fixed Effects model for `lwage` using `exper`, `expersq`, and `union` as predictors.
2.  Extract the individual fixed effects from your estimated model.
3.  Create a **histogram or density plot** to visualize the distribution of these fixed effects.
4.  **Interpret the plot:** What does the shape and spread of the distribution tell you about the sample? Does it appear that unobserved, time-constant individual differences are a significant factor in explaining wage variation?

The histogram shows a wide spread of fixed effects, suggesting substantial unobserved time-constant heterogeneity across individuals. Since these effects capture persistent individual differences not explained by the predictors, their significant variation implies that individual-specific factors play an important role in wage determination. The roughly bell-shaped but somewhat skewed distribution indicates most individuals cluster around the mean effect, with some outliers showing particularly high or low baseline wages.

:::{.panel-tabset}

### Python

```{python}
#| echo: true
import pandas as pd
import pyfixest as pf
import matplotlib.pyplot as plt

# Load data
df = pd.read_stata("../tutorials/datafiles/WAGEPAN.DTA")

# Estimate FE model
fit = pf.feols("lwage ~ exper + expersq + union | nr", data=df)

# Extract fixed effects
fe = pd.DataFrame(fit.fixef())

# Plot distribution
plt.hist(fe, bins=30, density=True, alpha=0.7)
plt.xlabel("Individual Fixed Effects")
plt.title("Distribution of Fixed Effects")
plt.show()
```

### R

```{r}
#| echo: true
library(fixest); library(ggplot2); library(haven)

# Load data (adjust path as needed)
df <- haven::read_dta("../tutorials/datafiles/WAGEPAN.DTA")

# Estimate FE model
fit <- feols(lwage ~ exper + expersq + union | nr, data = df)

# Extract fixed effects
fe <- fixef(fit)$nr

# Plot distribution
ggplot(data.frame(fe), aes(x = fe)) +
  geom_histogram(aes(y = after_stat(density)), bins = 30, alpha = 0.7) +
  labs(x = "Individual Fixed Effects", 
       title = "Distribution of Fixed Effects") +
  theme_minimal()

```

### Stata

```{stata}
#| eval: false
#| echo: true
* Load data (adjust path as needed)
use "../tutorials/datafiles/WAGEPAN.DTA", clear

* Estimate FE model
xtset nr
xtreg lwage exper expersq union, fe

* Store fixed effects
predict fe, u

* Plot distribution
histogram fe, bin(30) frequency normal ///
    title("Distribution of Fixed Effects") ///
    xtitle("Individual Fixed Effects")
```

:::

## Efficiency of FD vs FE Estimators

- The FD error:
  
  The FD estimator works by differencing the equation to eliminate the fixed effect $c_i$:
  
  $\Delta y_{it} = \beta \Delta x_{it} + \Delta \epsilon_{it}$
  
  where $\Delta y_{it} = y_{it} - y_{i,t-1}$ and so on.
  
  Let's focus on the transformed error term, $\Delta \epsilon_{it}$:
  
  $\Delta \epsilon_{it} = \epsilon_{it} - \epsilon_{i,t-1}$
  
  Now, we substitute the definition of the random walk process for $\epsilon_{it}$:
  
  $\Delta \epsilon_{it} = (\epsilon_{i,t-1} + \nu_{it}) - \epsilon_{i,t-1}$
  
  This simplifies to:
  
  $\Delta \epsilon_{it} = \nu_{it}$
  
  Since $\nu_{it}$ is defined as white noise, it is, by definition, **not serially correlated**. Therefore, the error term in the first-differenced model satisfies the classical OLS assumption of no serial correlation.

- The FE error:
  
  Let's analyze the transformed error term, $\tilde{\epsilon}_{it} = \epsilon_{it} - \bar{\epsilon}_i$, where $\bar{\epsilon}_i = \frac{1}{T} \sum_{s=1}^{T} \epsilon_{is}$.
  
  The de-meaned error at time $t$ is:
  $\tilde{\epsilon}_{it} = \epsilon_{it} - \frac{1}{T}(\epsilon_{i1} + \epsilon_{i2} + ... + \epsilon_{iT})$
  
  And the de-meaned error at time $t-1$ is:
  $\tilde{\epsilon}_{i,t-1} = \epsilon_{i,t-1} - \frac{1}{T}(\epsilon_{i1} + \epsilon_{i2} + ... + \epsilon_{iT})$
  
  To check for serial correlation, we need to determine if the covariance between $\tilde{\epsilon}_{it}$ and $\tilde{\epsilon}_{i,t-1}$ is zero.
  
  $Cov(\tilde{\epsilon}_{it}, \tilde{\epsilon}_{i,t-1}) = E[(\epsilon_{it} - \bar{\epsilon}_i)(\epsilon_{i,t-1} - \bar{\epsilon}_i)]$
  
  Because $\epsilon_{it}$ is a random walk, it is strongly serially correlated with its own past values. For instance, $\epsilon_{it} = \epsilon_{i,t-1} + \nu_{it}$, and $\epsilon_{i,t-1} = \epsilon_{i,t-2} + \nu_{i,t-1}$, and so on. This means that $\epsilon_{it}$ is a sum of all past white noise shocks.
  
  When we de-mean this series, the transformed error $\tilde{\epsilon}_{it}$ becomes a complex combination of all the original error terms for that individual. Both $\tilde{\epsilon}_{it}$ and $\tilde{\epsilon}_{i,t-1}$ share the same subtracted mean, $\bar{\epsilon}_i$, and their non-mean components, $\epsilon_{it}$ and $\epsilon_{i,t-1}$, are themselves highly correlated. The de-meaning process does not remove the underlying correlation structure of a random walk.
  
  As a result, the covariance between the de-meaned errors, $Cov(\tilde{\epsilon}_{it}, \tilde{\epsilon}_{i,t-1})$, will be non-zero. The transformed error term in the FE model **remains serially correlated**.
  
## The Mechanics of Transformation

**(a) The Within Estimator (De-meaning)**

**Step 1: Calculate Firm-Specific Means**
*   **For Firm A:**
    *   $\bar{y}_A = (5 + 7 + 6) / 3 = 18 / 3 = 6$
    *   $\bar{x}_A = (2 + 3 + 4) / 3 = 9 / 3 = 3$
*   **For Firm B:**
    *   $\bar{y}_B = (12 + 10 + 14) / 3 = 36 / 3 = 12$
    *   $\bar{x}_B = (6 + 5 + 7) / 3 = 18 / 3 = 6$

**Step 2: Construct De-meaned Variables**
Using the formula $\ddot{y}_{it} = y_{it} - \bar{y}_i$ and $\ddot{x}_{it} = x_{it} - \bar{x}_i$:

| Firm (i) | Year (t) | $\ddot{y}_{it}$ | $\ddot{x}_{it}$ |
|:--------:|:--------:|:---------------:|:---------------:|
|     A    |     1    | $5 - 6 = -1$    | $2 - 3 = -1$    |
|     A    |     2    | $7 - 6 = 1$     | $3 - 3 = 0$     |
|     A    |     3    | $6 - 6 = 0$     | $4 - 3 = 1$     |
|     B    |     1    | $12 - 12 = 0$   | $6 - 6 = 0$     |
|     B    |     2    | $10 - 12 = -2$  | $5 - 6 = -1$    |
|     B    |     3    | $14 - 12 = 2$   | $7 - 6 = 1$     |

**(b) The First Differences Estimator**

Using the formulas $\Delta y_{it} = y_{it} - y_{i,t-1}$ and $\Delta x_{it} = x_{it} - x_{i,t-1}$. Note that the first observation for each firm ($t=1$) is lost.

| Firm (i) | Year (t) | $\Delta y_{it}$ | $\Delta x_{it}$ |
|:--------:|:--------:|:---------------:|:---------------:|
|     A    |     2    | $7 - 5 = 2$     | $3 - 2 = 1$     |
|     A    |     3    | $6 - 7 = -1$    | $4 - 3 = 1$     |
|     B    |     2    | $10 - 12 = -2$  | $5 - 6 = -1$    |
|     B    |     3    | $14 - 10 = 4$   | $7 - 5 = 2$     |

You are left with **4 observations** in the differenced dataset. The general formula is $N(T-1)$, where $N$ is the number of individuals and $T$ is the number of time periods. Here, $2(3-1) = 4$.

**(c) Violation of Strict Exogeneity**

The **Strict Exogeneity** assumption states that the error term in any period $t$ must be uncorrelated with the explanatory variables in *all* periods (past, present, and future) for a given individual $i$. Formally, $E(u_{it} | X_{i1}, ..., X_{iT}) = 0$.

The scenario describes a "feedback effect": a past error term ($u_{i,t-1}$) influences a current explanatory variable ($X_{it}$). This means $Cov(X_{it}, u_{i,t-1}) \neq 0$.

This violates strict exogeneity and causes bias in both estimators:

*   **First Differences (FD):** The FD model regresses $\Delta X_{it}$ on $\Delta u_{it}$. The covariance between the regressor and the new error term is:
    $Cov(\Delta X_{it}, \Delta u_{it}) = Cov(X_{it} - X_{i,t-1}, u_{it} - u_{i,t-1})$
    Expanding this covariance gives four terms, one of which is $-Cov(X_{it}, u_{i,t-1})$. Since this term is non-zero by our scenario, the total covariance will be non-zero, and the FD estimator will be biased.
    
*   **Fixed Effects (FE):** The de-meaning process involves subtracting the mean $\bar{x}_i$, which is a function of all $X$'s for that individual, including $X_{it}$. Since $X_{it}$ is correlated with $u_{i,t-1}$, the de-meaned regressor $\ddot{x}_{it}$ will also be correlated with the error term $u_{i,t-1}$, violating the necessary conditions for consistency.

## Choosing Between FE and FD

**(a) Interpretation of Similar Results**

The fact that the FE and FD estimators produce very similar results (0.15 and 0.18) is reassuring. Both methods are designed to control for unobserved time-invariant heterogeneity ($\alpha_i$). Their similarity suggests that the estimate of $\beta$ is robust to the specific transformation method used. It provides confidence that the unobserved heterogeneity has been adequately addressed. It also gives suggestive (though not definitive) evidence that the strict exogeneity assumption holds, as a violation of this assumption could affect the two estimators differently and lead to divergent results.

**(b) Correlation of -0.48**

The choice between FE and FD depends on the time-series properties of the error term, $u_{it}$. As shown in the lecture:
*   **Theory:** If the original errors $u_{it}$ are serially uncorrelated (i.i.d.), then the first-differenced errors $\Delta u_{it}$ will have a serial correlation of exactly -0.5.

A correlation of **-0.48** is extremely close to -0.5. This is strong evidence that the underlying assumption of the FE model—that the idiosyncratic errors $u_{it}$ are serially uncorrelated—is correct.

*   **Conclusion:** In this case, the **Fixed Effects (FE) model is preferable**. When its underlying assumptions hold, the FE estimator is more efficient (i.e., it has a smaller variance and produces smaller standard errors) than the FD estimator.

**(c) Correlation of -0.05**

A correlation of **-0.05** is very close to zero and far from -0.5. This implies that the assumption of serially uncorrelated $u_{it}$ is violated.

*   **Theory:** If the first-differenced errors $\Delta u_{it}$ are serially uncorrelated (correlation near zero), it implies that the original error term $u_{it}$ likely follows a **random walk**. A random walk process is defined as $u_{it} = u_{i,t-1} + e_{it}$, where $e_{it}$ is an i.i.d. shock. In this case, the first difference is $\Delta u_{it} = e_{it}$, which is serially uncorrelated by definition.

*   **Conclusion:** In this scenario, the underlying assumptions of the FD model are met. The **First Differences (FD) model is preferable** because it is more efficient when the original errors follow a random walk.
